<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Note App</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 20px;
        }
        .notes-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .note {
            background-color: #fff3cd;
            padding: 15px;
            border-radius: 5px;
            width: 200px;
            height: 400px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            position: relative;
            cursor: grab;
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .note:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        .note textarea {
            width: 100%;
            height: 100px;
            border: none;
            background-color: aliceblue;
            resize: none;
        }
        .delete-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: red;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
        }
        .add-note-btn {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
        }
        .color-picker {
            display: flex;
            gap: 5px;
            margin-top: 10px;
        }
        .color-box {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
        }
        .color-box.selected {
            border-color: #000;
        }
        .uploaded-image {
            max-width: 100%;
            margin-top: 10px;
            border-radius: 5px;
        }
        .image-upload {
            margin-top: 10px;
        }
        .note-footer {
            margin-top: auto;
        }
        .scale-btn {
            position: absolute;
            bottom: 5px;
            right: 5px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 5px 10px;
            cursor: pointer;
        }
        .note.scaled {
            transform: scale(2) translate(-50%, -50%); /* Double size and center */
            position: fixed; /* Position relative to the viewport */
            top: 50%; /* Center vertically */
            left: 50%; /* Center horizontally */
            z-index: 1000; /* Bring to the front */
            transition: transform 0.3s ease, top 0.3s ease, left 0.3s ease; /* Smooth scaling and centering */
            width: 200px; /* Keep original width */
            height: 400px; /* Keep original height */
            overflow: auto; /* Add scroll if content overflows */
        }
        .note.scaled textarea {
            font-size: 1.2em; /* Scale font size */
        }
        .note.scaled .uploaded-image {
            max-width: 100%; /* Ensure images scale properly */
        }
    </style>
</head>
<body>
    <h1>Note App</h1>
    <button class="add-note-btn" onclick="addNote()">Add Note</button>
    <div class="notes-container" id="notes-container">
        <!-- Notes will be dynamically added here -->
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.4/socket.io.js"></script>
    <script>
        const socket = io();

        // Available colors
        const colors = ["#d4edda", "#fff3cd", "#f8d7da"]; // Green, Yellow, Red

        // Debugging: Check Socket.IO connection
        socket.on("connect", () => {
            console.log("Connected to server with socket ID:", socket.id);
        });

        socket.on("connect_error", (error) => {
            console.error("Connection error:", error);
        });

        // Generate UUID for new notes
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // Add a new note
        function addNote() {
            console.log("Add Note button clicked!"); // Debugging
            const newNote = { 
                id: generateUUID(), // Use custom UUID generator
                text: "New Note", 
                color: "#fff3cd" // Default color
            };
            console.log("Adding new note:", newNote); // Debugging
            socket.emit("add_note", newNote);
        }

        // Upload image for a note
        function uploadImage(noteId, file) {
            const formData = new FormData();
            formData.append("image", file);
            formData.append("noteId", noteId);

            fetch("/upload-image", {
                method: "POST",
                body: formData,
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    socket.emit("update_note", { id: noteId, note: { image: data.imagePath } });
                }
            })
            .catch(error => console.error("Error uploading image:", error));
        }

        // Fetch and display notes
        function fetchNotes() {
            fetch("/api/notes")
                .then(response => response.json())
                .then(notes => renderNotes(notes))
                .catch(error => console.error("Error fetching notes:", error));
        }

        // Render notes
        function renderNotes(notes) {
            const container = document.getElementById("notes-container");
            container.innerHTML = "";
            notes.forEach((note) => {
                const noteElement = document.createElement("div");
                noteElement.className = "note";
                noteElement.style.backgroundColor = note.color || "#fff3cd";
                noteElement.draggable = true;
                noteElement.dataset.id = note.id; // Use unique ID
                noteElement.innerHTML = `
                    <textarea oninput="updateNote('${note.id}', this.value)">${note.text}</textarea>
                    <button class="delete-btn" onclick="deleteNote('${note.id}')">Ã—</button>
                    ${note.image ? `<img src="${note.image}" class="uploaded-image" alt="Uploaded Image">` : ""}
                    <div class="note-footer">
                        <input type="file" accept="image/*" onchange="uploadImage('${note.id}', this.files[0])" class="image-upload">
                        <div class="color-picker">
                            ${colors.map(color => `
                                <div class="color-box ${note.color === color ? "selected" : ""}" 
                                     style="background-color: ${color};"
                                     onclick="changeNoteColor('${note.id}', '${color}')">
                                </div>
                            `).join("")}
                        </div>
                        <button class="scale-btn" onclick="scaleNote(this.closest('.note'))">Scale</button>
                    </div>
                `;
                container.appendChild(noteElement);

                // Add drag-and-drop event listeners
                noteElement.addEventListener("dragstart", (e) => {
                    e.dataTransfer.setData("text/plain", note.id);
                });
                noteElement.addEventListener("dragover", (e) => {
                    e.preventDefault();
                });
                noteElement.addEventListener("drop", (e) => {
                    e.preventDefault();
                    const fromId = e.dataTransfer.getData("text/plain");
                    const toId = note.id;
                    reorderNotes(fromId, toId);
                });
            });
        }

        // Update a note
        let timeoutId;
        function updateNote(id, text) {
            clearTimeout(timeoutId);
            timeoutId = setTimeout(() => {
                socket.emit("update_note", { id, note: { text } });
            }, 10000); // Debounced auto-save
        }

        // Change note color
        function changeNoteColor(id, color) {
            socket.emit("update_note", { id, note: { color } });
        }

        // Delete a note
        function deleteNote(id) {
            if (confirm("Are you sure you want to delete this note?")) {
                socket.emit("delete_note", id);
            }
        }

        // Reorder notes
        function reorderNotes(fromId, toId) {
            fetch("/api/notes")
                .then(response => response.json())
                .then(notes => {
                    const fromIndex = notes.findIndex(note => note.id === fromId);
                    const toIndex = notes.findIndex(note => note.id === toId);

                    if (fromIndex === -1 || toIndex === -1) return; // Invalid indices

                    // Move the note
                    const [movedNote] = notes.splice(fromIndex, 1);
                    notes.splice(toIndex, 0, movedNote);

                    // Send the updated list to the server
                    socket.emit("reorder_notes", notes);
                })
                .catch(error => console.error("Error reordering notes:", error));
        }

        // Function to scale or minimize a note
        function scaleNote(noteElement) {
            const scaleButton = noteElement.querySelector(".scale-btn");

            if (noteElement.classList.contains("scaled")) {
                // If the note is already scaled, minimize it
                noteElement.classList.remove("scaled");
                scaleButton.textContent = "Scale";
            } else {
                // If the note is not scaled, scale it
                unscaleAllNotes(); // Unscale all other notes first
                noteElement.classList.add("scaled");
                scaleButton.textContent = "Minimize";
            }
        }

        // Function to unscale all notes
        function unscaleAllNotes() {
            document.querySelectorAll(".note.scaled").forEach((note) => {
                note.classList.remove("scaled");
                const scaleButton = note.querySelector(".scale-btn");
                if (scaleButton) {
                    scaleButton.textContent = "Scale";
                }
            });
        }

        // Listen for updates from the server
        socket.on("update_notes", (notes) => {
            renderNotes(notes);
        });

        // Load notes on page load
        fetchNotes();
    </script>
</body>
</html>